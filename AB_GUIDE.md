# Apache Benchmark (ab) - Руководство пользователя

## Что такое Apache Benchmark?

Apache Benchmark (ab) - это инструмент командной строки для нагрузочного тестирования HTTP серверов. Он показывает, сколько запросов в секунду может обработать ваш сервер.

## Основные концепции

### Базовые параметры:

- **-n requests** - общее количество запросов для выполнения
- **-c concurrency** - количество одновременных запросов (потоков)
- **-t timelimit** - максимальное время тестирования в секундах

⚠️ **ВАЖНОЕ ПРАВИЛО:** `-c` (concurrency) всегда должно быть меньше или равно `-n` (requests)!

## Примеры использования

### Базовое тестирование

```bash
# 100 запросов, по 10 одновременно
ab -n 100 -c 10 http://example.com/

# Тест на 30 секунд с 5 одновременными запросами
ab -t 30 -c 5 http://example.com/
```

### Тестирование с Keep-Alive

```bash
# Использование HTTP Keep-Alive для повторного использования соединений
ab -k -n 1000 -c 50 http://example.com/
```

### POST запросы

```bash
# POST запрос с данными из файла
ab -n 100 -c 10 -p data.json -T "application/json" http://example.com/api
```

### Добавление заголовков

```bash
# Добавление пользовательских заголовков
ab -n 100 -c 10 -H "Authorization: Bearer token123" http://example.com/api
```

### Добавление cookies

```bash
# Добавление cookies
ab -n 100 -c 10 -C "session=abc123" http://example.com/
```

## Локальное тестирование vs Продакшн

### Локальное тестирование (Development)

**Цели:**

- Найти узкие места в коде
- Проверить производительность новых функций
- Тестирование до деплоя

**Пример команд:**

```bash
# Локальный сервер (обычно на localhost)
ab -k -n 1000 -c 20 http://localhost:5173/api/health

# Более агрессивное тестирование (больше потоков)
ab -k -n 5000 -c 100 http://localhost:5173/api/users
```

**Особенности:**

- Можно использовать высокие значения concurrency
- Сеть не является ограничением
- Фокус на логике приложения

### Тестирование продакшн сервера

**Цели:**

- Проверить реальную производительность
- Учесть сетевые задержки
- Проверить CDN и load balancer

**Пример команд:**

```bash
# Мягкое тестирование продакшн сервера
ab -k -n 500 -c 10 https://api.example.com/health

# Постепенное увеличение нагрузки
ab -k -n 1000 -c 25 https://api.example.com/api/v1/data
```

**Особенности:**

- Начинайте с малых значений concurrency
- Учитывайте rate limiting
- Сетевые задержки влияют на результаты
- Уважайте ресурсы продакшн сервера

## Анализ результатов

### Ключевые метрики:

1. **Requests per second** - запросов в секунду (RPS)
2. **Time per request** - среднее время ответа
3. **Failed requests** - количество неудачных запросов
4. **Transfer rate** - скорость передачи данных

### Пример вывода:

```
Concurrency Level:      10
Time taken for tests:   2.345 seconds
Complete requests:      100
Failed requests:        0
Requests per second:    42.64 [#/sec] (mean)
Time per request:       234.500 [ms] (mean)
Time per request:       23.450 [ms] (mean, across all concurrent requests)
Transfer rate:          15.23 [Kbytes/sec] received
```

## Практические советы

### Для локального тестирования:

1. Используйте `-k` (Keep-Alive) для более реалистичных результатов
2. Начинайте с небольших значений и увеличивайте постепенно
3. Тестируйте разные endpoints отдельно

### Для продакшн тестирования:

1. **ВСЕГДА** получайте разрешение перед нагрузочным тестированием
2. Начинайте с малых нагрузок (c=1-5)
3. Увеличивайте нагрузку постепенно
4. Мониторьте логи сервера во время тестирования
5. Тестируйте в нерабочие часы

### Исправление частых ошибок:

**Ошибка:** "Cannot use concurrency level greater than total number of requests"

```bash
# Неправильно:
ab -c 5 -n 1 http://example.com/

# Правильно:
ab -c 1 -n 5 http://example.com/
# или
ab -c 5 -n 10 http://example.com/
```

## Расширенные параметры

```bash
# Тестирование с таймаутом
ab -n 100 -c 10 -s 60 http://example.com/

# Подробный вывод
ab -n 100 -c 10 -v 2 http://example.com/

- verbosity levels:
1 - minimal
2 - warnings/info
3 - response codes
4 - headers

# Сохранение результатов в CSV
ab -n 100 -c 10 -e results.csv http://example.com/

# Игнорирование ошибок длины ответа (для динамических страниц)
ab -n 100 -c 10 -l http://example.com/api/random
```

## Альтернативы Apache Benchmark

Для более сложных сценариев рассмотрите:

- **wrk** - современная альтернатива с Lua скриптами
- **artillery** - для API тестирования с JSON конфигурацией
- **k6** - для комплексного тестирования производительности
- **JMeter** - GUI инструмент для сложных сценариев
